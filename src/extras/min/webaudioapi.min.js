(function(e){"use strict";function t(t){e.Object.call(this,2,t),n.fixAR(this);var r=this._;r.mode="",r.bufferL=new n.SignalArray(s<<2),r.bufferR=new n.SignalArray(s<<2),r.buffermask=r.bufferL.length-1,r.node=null,r.script=i.createJavaScriptNode(s,2,2),r.writeIndex=0,r.readIndex=0,r.totalRead=0,r.totalWrite=0}if("webkit"===e.env){var n=e.fn,i=n._audioContext,s=1024;n.extend(t);var r=t.prototype;Object.defineProperties(r,{context:{get:function(){return i}},mode:{get:function(){return this._.mode}}}),r.cancel=function(){for(var e=this._,t=this.cells[0],n=0,i=t.length;i>n;++n)t[n]=0;e.node=null},function(){function e(e){t.call(this,e);var n=this._;n.mode="recv",n.script.onaudioprocess=s(this),n.gain=i.createGainNode(),n.gain.gain.value=0,n.script.connect(n.gain)}n.extend(e,t);var s=function(e){return function(t){var n=e._,i=t.inputBuffer,s=i.getChannelData(0),r=i.getChannelData(1),a=i.length,o=n.writeIndex;n.bufferL.set(s,o),n.bufferR.set(r,o),n.writeIndex=o+a&n.buffermask,n.totalWrite+=a}},r=e.prototype;r.cancel=function(){t.prototype.cancel.call(this),this._.gain.disconnect(),this._.node&&this._.node.disconnect()},r.recv=function(e){var t=this._;try{t.node=e,t.node.connect(t.script),t.gain.connect(i.destination)}catch(n){t.node=null}return t.writeIndex=0,t.readIndex=0,t.totalWrite=0,t.totalRead=0,this},r.process=function(e){var t=this._;if(null===t.node)return this;if(this.tickID!==e){this.tickID=e;var i=t.cellsize,s=t.bufferL,r=t.bufferR;if(t.totalWrite>t.totalRead+i){var a=t.readIndex,o=a+i;this.cells[1].set(s.subarray(a,o)),this.cells[2].set(r.subarray(a,o)),t.readIndex=o&t.buffermask,t.totalRead+=i}n.outputSignalAR(this)}return this},n.register("WebAudioAPI:recv",e)}(),function(){function e(e){t.call(this,e),n.listener(this);var s=this._;s.mode="send",s.script.onaudioprocess=i(this),s.connectIndex=null}n.extend(e,t);var i=function(e){return function(t){var n=e._,i=t.outputBuffer,s=i.length;if(n.totalWrite>n.totalRead+s){var r=n.readIndex,a=r+s;i.getChannelData(0).set(n.bufferL.subarray(r,a)),i.getChannelData(1).set(n.bufferR.subarray(r,a)),n.readIndex=a&n.buffermask,n.totalRead+=s}}},s=e.prototype;s.cancel=function(){t.prototype.cancel.call(this);var e=this._;null!==e.connectIndex?e.script.disconnect(e.connectIndex):e.script.disconnect(),this.unlisten()},s.send=function(e,t){var n=this._;try{n.node=e,"number"==typeof t?(n.script.connect(n.node,t),n.connectIndex=t):(n.script.connect(n.node),n.connectIndex=null),this.listen()}catch(i){n.node=null}return n.writeIndex=0,n.readIndex=0,n.totalWrite=0,n.totalRead=0,this},s.process=function(e){var t=this._;if(null===t.script)return this;if(this.tickID!==e){this.tickID=e;var i=this.cells[1],s=this.cells[2],r=t.cellsize,a=t.writeIndex;n.inputSignalAR(this),t.bufferL.set(i,a),t.bufferR.set(s,a),t.writeIndex=a+r&t.buffermask,t.totalWrite+=r,n.outputSignalAR(this)}return this},n.register("WebAudioAPI:send",e)}()}})(timbre);